<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Progressive Tracker V2</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #007aff; --success: #34c759; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; padding-bottom: 80px; }
        
        /* Layout */
        .container { padding: 16px; max-width: 600px; margin: 0 auto; }
        .header-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        h1 { font-size: 24px; font-weight: 700; margin: 0; }
        
        /* Cards */
        .card { background-color: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); position: relative; }
        .card-header { display: flex; justify-content: space-between; align-items: center; }
        .exercise-name { font-size: 18px; font-weight: 600; color: #fff; }
        .day-title { font-size: 20px; font-weight: bold; color: var(--accent); }
        .target-text { color: var(--success); font-weight: 600; font-size: 15px; margin-top: 6px; }
        
        /* Inputs & Buttons */
        input, select, textarea { background: #333; border: none; color: white; padding: 12px; border-radius: 8px; width: 100%; box-sizing: border-box; font-size: 16px; margin-bottom: 12px; }
        button { border: none; padding: 12px 20px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 8px; }
        .btn-primary { background-color: var(--accent); color: white; }
        .btn-secondary { background-color: #333; color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-danger { background-color: #ff3b30; color: white; }
        .btn-text { background: none; color: var(--accent); padding: 0; width: auto; margin: 0; }
        
        .fab { position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: var(--accent); color: white; font-size: 28px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,122,255,0.4); border: none; z-index: 50; }

        /* Set Logging Row */
        .set-row { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 8px; align-items: center; margin-bottom: 8px; }
        .set-label { font-size: 12px; color: #888; text-align: center; margin-bottom: 4px; }
        .del-btn { background: #ff3b30; color: white; width: 30px; height: 38px; display: flex; align-items: center; justify-content: center; padding: 0; border-radius: 6px; margin-top: 0;}

        /* Utilities */
        .hidden { display: none !important; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .previous-notes { background: #2c2c2e; padding: 10px; border-radius: 8px; font-size: 14px; color: #ddd; margin-bottom: 15px; border-left: 4px solid var(--accent); }
        .back-btn { font-size: 24px; margin-right: 10px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    
    <div id="view-home">
        <div class="header-row">
            <h1>My Program</h1>
        </div>
        <div id="days-list"></div>
        <div style="margin-top:40px; text-align:center; color:#555; font-size:14px;">
            Tap + to add a workout day & exercise
        </div>
    </div>

    <div id="view-day" class="hidden">
        <div class="header-row">
            <div style="display:flex; align-items:center;">
                <span class="back-btn" onclick="goHome()">&#8592;</span>
                <h1 id="day-title-display">Day Name</h1>
            </div>
        </div>
        <div id="exercises-list"></div>
    </div>

</div>

<div id="modal-edit" class="modal hidden">
    <h2>Setup Exercise</h2>
    
    <label class="set-label" style="text-align:left; display:block;">Workout Day Name</label>
    <input type="text" id="edit-day" placeholder="e.g. Push A, Legs, Monday" list="day-suggestions">
    <datalist id="day-suggestions"></datalist>

    <label class="set-label" style="text-align:left; display:block; margin-top:10px;">Exercise Name</label>
    <input type="text" id="edit-name" placeholder="e.g. Bench Press">
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div>
            <label class="set-label">Min Reps</label>
            <input type="number" id="edit-min-reps" placeholder="8">
        </div>
        <div>
            <label class="set-label">Max Reps</label>
            <input type="number" id="edit-max-reps" placeholder="10">
        </div>
    </div>
    
    <label class="set-label">Weight Increment (next level)</label>
    <input type="number" id="edit-increment" placeholder="2.5">

    <button class="btn-success" onclick="saveExerciseConfig()">Save</button>
    <button class="btn-secondary" onclick="closeModals()">Cancel</button>
    <button class="btn-danger" id="btn-delete-ex" style="margin-top:20px" onclick="deleteExercise()">Delete Exercise</button>
</div>

<div id="modal-log" class="modal hidden">
    <h2 id="log-title">Log Set</h2>
    
    <div id="prev-data-area" class="previous-notes hidden">
        <strong>Last Time:</strong> <span id="prev-best-display"></span><br>
        <strong>Note:</strong> <span id="prev-note-display"></span>
    </div>

    <div class="card" style="border: 1px solid var(--accent);">
        <div class="card-header">
            <span style="color:var(--accent); font-size:12px; font-weight:bold; letter-spacing:1px;">TODAY'S TARGET</span>
        </div>
        <div style="font-size: 22px; font-weight: bold; color:white;" id="target-display">...</div>
    </div>

    <div class="set-row">
        <div class="set-label">Kg/Lbs</div>
        <div class="set-label">Reps</div>
        <div class="set-label">RPE</div>
        <div></div>
    </div>
    <div id="sets-container"></div>
    <button class="btn-secondary" onclick="addSetRow()">+ Add Set</button>
    
    <h3 style="margin-top:20px; font-size:16px;">Notes</h3>
    <textarea id="session-notes" rows="3" placeholder="How did it feel?"></textarea>

    <button class="btn-success" style="margin-top:20px" onclick="saveLog()">Complete Exercise</button>
    <button class="btn-secondary" onclick="closeModals()">Cancel</button>
</div>

<button class="fab" onclick="openEditModal()">+</button>

<script>
    // --- Data & State ---
    let exercises = JSON.parse(localStorage.getItem('exercises')) || [];
    let activeDay = null; // Tracks which day folder we are currently viewing
    let activeExerciseIndex = null; // Tracks which exercise we are editing/logging

    // Fix for older version users: Ensure everyone has a 'day' property
    exercises.forEach(ex => { if(!ex.day) ex.day = "Uncategorized"; });

    // --- Navigation & Views ---
    function goHome() {
        activeDay = null;
        document.getElementById('view-home').classList.remove('hidden');
        document.getElementById('view-day').classList.add('hidden');
        renderHome();
    }

    function goToDay(dayName) {
        activeDay = dayName;
        document.getElementById('view-home').classList.add('hidden');
        document.getElementById('view-day').classList.remove('hidden');
        document.getElementById('day-title-display').innerText = dayName;
        renderDayExercises();
    }

    // --- Rendering ---
    function renderHome() {
        const list = document.getElementById('days-list');
        list.innerHTML = '';
        
        // Get unique days
        const days = [...new Set(exercises.map(ex => ex.day))].sort();

        days.forEach(day => {
            const div = document.createElement('div');
            div.className = 'card';
            div.style.cursor = 'pointer';
            // Count exercises
            const count = exercises.filter(e => e.day === day).length;
            
            div.innerHTML = `
                <div class="card-header">
                    <span class="day-title">${day}</span>
                    <span style="font-size:24px; color:#555;">&rsaquo;</span>
                </div>
                <div style="color:#888; font-size:14px; margin-top:4px;">${count} Exercises</div>
            `;
            div.onclick = () => goToDay(day);
            list.appendChild(div);
        });

        // Update datalist for auto-complete
        const datalist = document.getElementById('day-suggestions');
        datalist.innerHTML = '';
        days.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d;
            datalist.appendChild(opt);
        });
    }

    function renderDayExercises() {
        const list = document.getElementById('exercises-list');
        list.innerHTML = '';
        
        // Filter exercises for this day
        exercises.forEach((ex, index) => {
            if (ex.day !== activeDay) return;

            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `
                <div class="card-header">
                    <span class="exercise-name">${ex.name}</span>
                    <button class="btn-text" onclick="openEditModal(${index})">Edit</button>
                </div>
                <div class="target-text">Target: ${calculateTarget(ex)}</div>
                <div style="font-size:12px; color:#666; margin-top:4px;">Range: ${ex.minReps}-${ex.maxReps} | +${ex.increment}kg</div>
                <button class="btn-primary" onclick="openLogModal(${index})">Log Workout</button>
            `;
            list.appendChild(div);
        });
    }

    // --- Logic: Target Calc ---
    function calculateTarget(ex) {
        if (!ex.history || ex.history.length === 0) {
            return `Start: ${ex.minReps}-${ex.maxReps} reps`;
        }
        
        const lastLog = ex.history[ex.history.length - 1];
        // Find best set (Max Weight, then Max Reps)
        let bestSet = lastLog.sets.reduce((prev, current) => {
            if (parseFloat(current.weight) > parseFloat(prev.weight)) return current;
            if (parseFloat(current.weight) === parseFloat(prev.weight) && parseInt(current.reps) > parseInt(prev.reps)) return current;
            return prev;
        }, {weight: 0, reps: 0});

        // Conversion for safety
        let bestWeight = parseFloat(bestSet.weight);
        let bestReps = parseInt(bestSet.reps);

        if (bestReps >= ex.maxReps) {
            // Progression: Increase weight, reset reps
            return `${bestWeight + parseFloat(ex.increment)}kg x ${ex.minReps}-${ex.maxReps} Reps`;
        } else {
            // Progression: Add 1 rep
            return `${bestWeight}kg x ${bestReps + 1} Reps`;
        }
    }

    // --- Modals ---
    function closeModals() {
        document.getElementById('modal-edit').classList.add('hidden');
        document.getElementById('modal-log').classList.add('hidden');
    }

    function openEditModal(index = null) {
        closeModals();
        document.getElementById('modal-edit').classList.remove('hidden');
        activeExerciseIndex = index;
        const delBtn = document.getElementById('btn-delete-ex');

        if (index !== null) {
            // Edit existing
            const ex = exercises[index];
            document.getElementById('edit-day').value = ex.day;
            document.getElementById('edit-name').value = ex.name;
            document.getElementById('edit-min-reps').value = ex.minReps;
            document.getElementById('edit-max-reps').value = ex.maxReps;
            document.getElementById('edit-increment').value = ex.increment;
            delBtn.classList.remove('hidden');
        } else {
            // Create new
            document.getElementById('edit-day').value = activeDay || ''; // Pre-fill day if inside a folder
            document.getElementById('edit-name').value = '';
            document.getElementById('edit-min-reps').value = '';
            document.getElementById('edit-max-reps').value = '';
            document.getElementById('edit-increment').value = '';
            delBtn.classList.add('hidden');
        }
    }

    function saveExerciseConfig() {
        const day = document.getElementById('edit-day').value.trim();
        const name = document.getElementById('edit-name').value.trim();
        const min = parseInt(document.getElementById('edit-min-reps').value);
        const max = parseInt(document.getElementById('edit-max-reps').value);
        const inc = parseFloat(document.getElementById('edit-increment').value);

        if(!day || !name || !min || !max || !inc) return alert("Please fill all fields.");

        const newEx = { 
            day, name, minReps: min, maxReps: max, increment: inc, 
            history: (activeExerciseIndex !== null) ? exercises[activeExerciseIndex].history : [] 
        };

        if (activeExerciseIndex !== null) {
            exercises[activeExerciseIndex] = newEx;
        } else {
            exercises.push(newEx);
        }

        localStorage.setItem('exercises', JSON.stringify(exercises));
        closeModals();
        
        // Refresh view
        if (activeDay === day) renderDayExercises();
        else if (activeDay === null) renderHome();
        else goHome(); // If changed day, go back to home to see new structure
    }

    function deleteExercise() {
        if(confirm("Delete this exercise permanently?")) {
            exercises.splice(activeExerciseIndex, 1);
            localStorage.setItem('exercises', JSON.stringify(exercises));
            closeModals();
            renderDayExercises();
        }
    }

    // --- Logging ---
    function openLogModal(index) {
        closeModals();
        activeExerciseIndex = index;
        const ex = exercises[index];
        
        document.getElementById('modal-log').classList.remove('hidden');
        document.getElementById('log-title').innerText = ex.name;
        document.getElementById('target-display').innerText = calculateTarget(ex);
        
        // Setup Prev Data
        const prevArea = document.getElementById('prev-data-area');
        if (ex.history && ex.history.length > 0) {
            const last = ex.history[ex.history.length - 1];
            prevArea.classList.remove('hidden');
            document.getElementById('prev-note-display').innerText = last.notes || "-";
            
            // Calc best set of last session
            let best = last.sets.reduce((p, c) => (parseFloat(c.weight) > parseFloat(p.weight) || (parseFloat(c.weight) == parseFloat(p.weight) && parseInt(c.reps) > parseInt(p.reps))) ? c : p, {weight:0, reps:0});
            document.getElementById('prev-best-display').innerText = `${best.weight}kg x ${best.reps}`;
        } else {
            prevArea.classList.add('hidden');
        }

        // Reset Inputs
        document.getElementById('sets-container').innerHTML = '';
        addSetRow(); addSetRow(); addSetRow();
        document.getElementById('session-notes').value = '';
    }

    function addSetRow() {
        const div = document.createElement('div');
        div.className = 'set-row';
        div.innerHTML = `
            <input type="number" class="log-weight" placeholder="Kg">
            <input type="number" class="log-reps" placeholder="Reps">
            <input type="number" class="log-rpe" placeholder="RPE">
            <button class="del-btn" onclick="this.parentElement.remove()">X</button>
        `;
        document.getElementById('sets-container').appendChild(div);
    }

    function saveLog() {
        const rows = document.querySelectorAll('.set-row');
        const sets = [];
        rows.forEach(row => {
            const w = row.querySelector('.log-weight').value;
            const r = row.querySelector('.log-reps').value;
            const rpe = row.querySelector('.log-rpe').value;
            if(w && r) sets.push({ weight: w, reps: r, rpe: rpe });
        });

        if(sets.length === 0) return alert("Please log data.");
        
        exercises[activeExerciseIndex].history.push({
            date: new Date().toISOString(),
            sets: sets,
            notes: document.getElementById('session-notes').value
        });

        localStorage.setItem('exercises', JSON.stringify(exercises));
        closeModals();
        renderDayExercises();
    }

    // --- Init ---
    renderHome();

</script>
</body>
</html>
