<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Tracker V13 (Timer)</title>
    <link rel="apple-touch-icon" href="https://img.icons8.com/ios-filled/180/007aff/dumbbell.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/ios-filled/180/007aff/dumbbell.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --bg: #000000; --card: #1c1c1e; --text: #f2f2f7; --accent: #0a84ff; --success: #30d158; --danger: #ff453a; --sub: #8e8e93; --border: #2c2c2e; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; }
        .container { padding: 16px; max-width: 600px; margin: 0 auto; }
        h1 { font-size: 28px; font-weight: 800; margin: 0; letter-spacing: -0.5px; }
        
        /* HEADER & MENU */
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: relative; width: 100%; }
        .dropdown-menu { position: absolute; top: 40px; right: 0; background: #252525; border: 1px solid #333; border-radius: 12px; padding: 6px; width: 180px; z-index: 200; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .menu-item { display: block; width: 100%; padding: 12px; text-align: left; background: none; border: none; color: #eee; font-size: 15px; border-radius: 8px; cursor: pointer; }
        .menu-item:active { background: #3a3a3c; }
        .menu-item.danger { color: var(--danger); }
        .menu-overlay { position: fixed; top:0; left:0; width:100%; height:100%; z-index:190; display:none; }

        .card { background: var(--card); border-radius: 14px; padding: 16px; margin-bottom: 12px; position: relative; border: 1px solid var(--border); }
        .row { display: flex; justify-content: space-between; align-items: center; }
        .row-start { display: flex; justify-content: flex-start; align-items: center; gap: 10px; }
        
        .btn-icon { background: none; border: none; color: var(--accent); font-size: 22px; padding: 4px 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-move { color: var(--sub); font-size: 14px; padding: 4px 8px; background: #2c2c2e; border-radius: 4px; margin-left: 4px; }
        .ex-title { font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 4px; display: block;}
        .meta-text { font-size: 13px; color: var(--sub); display: block; }
        .target-text { font-size: 14px; color: var(--success); font-weight: 600; margin-top: 6px; display: block; }
        .target-pill { display: inline-block; font-size: 11px; font-weight: bold; padding: 2px 6px; border-radius: 4px; margin-top: 2px; color: #000; background: var(--success); }
        .target-pill.regress { background: var(--danger); color: white; }
        .target-pill.hold { background: #ff9f0a; color: white; }

        /* INPUTS */
        input, select, textarea { background: #2c2c2e; border: none; color: white; padding: 12px; border-radius: 10px; width: 100%; box-sizing: border-box; font-size: 16px; margin-bottom: 12px; font-family: inherit; }
        input[type="date"] { color-scheme: dark; } 
        button { border: none; padding: 14px; border-radius: 12px; font-size: 16px; font-weight: 600; width: 100%; cursor: pointer; margin-top: 8px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-secondary { background: #3a3a3c; color: white; }
        .btn-success { background: var(--success); color: black; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-small { padding: 8px 16px; font-size: 13px; width: auto; margin:0; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 100; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .hidden { display: none !important; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .set-row { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 8px; margin-bottom: 12px; align-items: center; }
        
        /* SUPERSET STYLES */
        .super-block { background: #252525; padding: 10px; border-radius: 8px; margin-bottom: 10px; position: relative; border-left: 3px solid var(--accent); }
        .super-row { display: flex; gap: 8px; margin-bottom: 6px; align-items: center; }
        .super-label { width: 30px; font-weight: bold; font-size: 13px; color: #888; text-align: center; text-transform: uppercase;}
        .super-del { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); height: 30px; width: 30px; background: #3a3a3c; color: var(--danger); border-radius: 4px; display:flex; align-items:center; justify-content:center; cursor:pointer;}
        
        .prev-data { font-size: 11px; color: #888; margin-bottom: 4px; display: block; text-align: right; width: 100%; }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        .history-table th, .history-table td { border: 1px solid #333; padding: 8px; text-align: center; color: #ddd; }
        .history-table th { background: #222; color: var(--accent); }

        .chart-container { position: relative; height: 250px; width: 100%; margin-bottom: 20px; }
        .fab { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; border-radius: 30px; background: var(--accent); color: white; font-size: 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px rgba(10,132,255,0.4); border: none; z-index: 50; }
        
        /* TIMER STYLES */
        #timer-container { background: #1c1c1e; padding: 12px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #333; }
        #timer-display { font-variant-numeric: tabular-nums; font-size: 24px; font-weight: 700; color: #fff; letter-spacing: 1px; }
        .timer-btn { padding: 6px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; width: auto; margin: 0; }
        
        .last-note-box { background: rgba(10, 132, 255, 0.1); border-left: 3px solid var(--accent); color: #ccc; padding: 10px; font-size: 13px; margin-bottom: 15px; border-radius: 6px; font-style: italic;}
    </style>
</head>
<body>

<div class="container" id="app">
    <div id="view-home">
        <div class="header-row">
            <h1>My Program</h1>
            <button class="btn-icon" onclick="toggleMenu()">‚ãÆ</button>
            <div id="home-menu" class="dropdown-menu hidden">
                <button class="menu-item" onclick="exportData()">üíæ Export Backup</button>
                <button class="menu-item" onclick="triggerImport()">üìÇ Import Backup</button>
                <button class="menu-item danger" onclick="resetAllData()">üóë Reset Data</button>
            </div>
        </div>
        <div id="menu-overlay" class="menu-overlay" onclick="toggleMenu()"></div>
        <input type="file" id="file-input" style="display:none" onchange="importData(this)">
        <div id="days-list"></div>
    </div>

    <div id="view-day" class="hidden">
        <div class="row" style="margin-bottom: 20px;">
            <div class="row-start">
                <button class="btn-icon" style="font-size:24px; padding:0;" onclick="goHome()">&#8592;</button>
                <h1 id="day-title" style="margin:0;">Day</h1>
            </div>
        </div>
        
        <div id="timer-container">
            <div id="timer-display">00:00:00</div>
            <button id="timer-btn" class="timer-btn btn-success" onclick="toggleTimer()">Start</button>
        </div>

        <div id="exercises-list"></div>
    </div>

    <div id="view-stats" class="hidden">
        <div class="row" style="margin-bottom: 20px;">
            <div class="row-start">
                <button class="btn-icon" style="font-size:24px; padding:0;" onclick="closeStats()">&#8592;</button>
                <h1 style="margin:0;">Analytics</h1>
            </div>
        </div>
        <h2 id="stats-title" style="color:var(--accent); margin-bottom:10px;">Exercise Name</h2>
        <div class="card">
            <h3 style="margin:0 0 10px 0; font-size:16px;">Strength & Volume</h3>
            <div class="chart-container"><canvas id="progressChart"></canvas></div>
        </div>
        <div class="card">
            <h3 style="margin:0 0 10px 0; font-size:16px;">Last 4 Sessions</h3>
            <div style="overflow-x:auto;"><table class="history-table" id="stats-table"></table></div>
        </div>
    </div>
</div>

<div id="modal-edit" class="modal hidden">
    <h2>Setup Exercise</h2>
    <label class="meta-text">Day</label><input type="text" id="cfg-day" list="day-list-suggestions">
    <datalist id="day-list-suggestions"></datalist>
    <label class="meta-text">Type</label>
    <select id="cfg-type" onchange="renderConfigFields()">
        <option value="normal">Normal</option>
        <option value="superset">Superset</option>
        <option value="giant">Giant Set</option>
        <option value="myo">Myo Match (Rest-Pause)</option>
    </select>
    <div id="cfg-dynamic-area" style="margin-top:15px;"></div>
    <button class="btn-success" onclick="saveExercise()">Save</button>
    <button class="btn-secondary" onclick="closeModals()">Cancel</button>
    <button class="btn-danger" id="btn-delete" style="margin-top:20px;" onclick="deleteExercise()">Delete</button>
</div>

<div id="modal-log" class="modal hidden">
    <h2 id="log-title">Log Workout</h2>
    <input type="date" id="log-date">
    <div id="last-note-box" class="last-note-box hidden"></div>
    <div id="log-inputs"></div>
    <button class="btn-secondary" onclick="addSetInputRow(null, true)" id="btn-add-set">+ Add Set</button>
    <label class="meta-text" style="margin-top:20px;">Today's Notes</label>
    <textarea id="log-notes" rows="2" placeholder="How did it feel?"></textarea>
    <button class="btn-success" onclick="saveLog()">Complete Workout</button>
    <button class="btn-secondary" onclick="closeModals()">Cancel</button>
</div>

<button class="fab" onclick="openEditModal()">+</button>

<script>
// --- DATA ---
let exercises = JSON.parse(localStorage.getItem('exercises_v6'));
let dayOrder = JSON.parse(localStorage.getItem('day_order_v6'));
if (!exercises) { exercises = JSON.parse(localStorage.getItem('exercises_v3')) || []; localStorage.setItem('exercises_v6', JSON.stringify(exercises)); }
if (!dayOrder) { dayOrder = JSON.parse(localStorage.getItem('day_order_v3')) || []; localStorage.setItem('day_order_v6', JSON.stringify(dayOrder)); }
exercises.forEach(ex => { if(!ex.id) ex.id = Date.now() + Math.random().toString(16).slice(2); });
let activeDay = null, editIndex = null, chartInstance = null;

// --- TIMER LOGIC ---
let timerInterval;
function updateTimerDisplay() {
    const start = localStorage.getItem('timerStart');
    const display = document.getElementById('timer-display');
    const btn = document.getElementById('timer-btn');
    if (!start) {
        display.innerText = "00:00:00";
        btn.innerText = "Start"; btn.className = "timer-btn btn-success";
        return;
    }
    const diff = Math.floor((Date.now() - parseInt(start)) / 1000);
    const h = Math.floor(diff / 3600).toString().padStart(2, '0');
    const m = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
    const s = (diff % 60).toString().padStart(2, '0');
    display.innerText = `${h}:${m}:${s}`;
    btn.innerText = "Stop"; btn.className = "timer-btn btn-danger";
}
function toggleTimer() {
    if (localStorage.getItem('timerStart')) {
        if(confirm("Stop Timer?")) { localStorage.removeItem('timerStart'); clearInterval(timerInterval); updateTimerDisplay(); }
    } else {
        localStorage.setItem('timerStart', Date.now());
        timerInterval = setInterval(updateTimerDisplay, 1000);
        updateTimerDisplay();
    }
}
setInterval(updateTimerDisplay, 1000); // Global ticker

// --- MENU & BACKUP ---
function toggleMenu() { document.getElementById('home-menu').classList.toggle('hidden'); document.getElementById('menu-overlay').style.display = document.getElementById('home-menu').classList.contains('hidden') ? 'none' : 'block'; }
function triggerImport() { toggleMenu(); document.getElementById('file-input').click(); }
function exportData() { toggleMenu(); const data = { exercises, dayOrder, version: "13.0", date: new Date().toISOString() }; const node = document.createElement('a'); node.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data)); node.download = "workout_backup_" + new Date().toISOString().slice(0,10) + ".json"; document.body.appendChild(node); node.click(); node.remove(); }
function importData(input) { const file = input.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = e => { try { const data = JSON.parse(e.target.result); if(data.exercises && confirm("Overwrite data?")) { exercises = data.exercises; dayOrder = data.dayOrder || []; localStorage.setItem('exercises_v6', JSON.stringify(exercises)); location.reload(); } } catch(err) { alert("Error."); } }; reader.readAsText(file); }

// --- VIEWS ---
function goHome() { activeDay = null; toggleViews('home'); renderHome(); }
function openDay(day) { activeDay = day; toggleViews('day'); document.getElementById('day-title').innerText = day; renderExercises(); updateTimerDisplay(); }
function closeStats() { toggleViews(activeDay ? 'day' : 'home'); }
function toggleViews(v) { ['view-home','view-day','view-stats'].forEach(id => document.getElementById(id).classList.add('hidden')); document.getElementById('view-'+v).classList.remove('hidden'); }

// --- RENDER ---
function renderHome() {
    const list = document.getElementById('days-list'); list.innerHTML = '';
    let distinct = [...new Set(exercises.map(e => e.day))]; dayOrder = dayOrder.filter(d => distinct.includes(d)); distinct.forEach(d => { if(!dayOrder.includes(d)) dayOrder.push(d); });
    localStorage.setItem('day_order_v6', JSON.stringify(dayOrder));
    document.getElementById('day-list-suggestions').innerHTML = dayOrder.map(d => `<option value="${d}">`).join('');
    dayOrder.forEach(day => {
        const count = exercises.filter(e => e.day === day).length;
        list.innerHTML += `<div class="card"><div class="row"><div onclick="openDay('${day}')" style="flex:1; cursor:pointer;"><span class="ex-title">${day}</span><span class="meta-text">${count} Exercises</span></div><div><button class="btn-move" onclick="moveDay('${day}', -1)">‚ñ≤</button><button class="btn-move" onclick="moveDay('${day}', 1)">‚ñº</button></div></div></div>`;
    });
}

function renderExercises() {
    const list = document.getElementById('exercises-list'); list.innerHTML = '';
    exercises.forEach((ex, idx) => {
        if(ex.day !== activeDay) return;
        let subtext = `${ex.sets || 3} Sets`;
        let targetDisplay = "";

        if (ex.type === 'normal') {
            const t = getSmartTarget(ex, 0); 
            if(t.weight) targetDisplay = `<span class="target-text">Target: ${t.weight}kg x ${t.reps}</span>`;
        } else if (ex.type === 'superset') {
            const tA = getSmartTarget(ex, 0, 'A'); const tB = getSmartTarget(ex, 0, 'B');
            if(tA.weight || tB.weight) targetDisplay = `<span class="target-text" style="font-size:13px;">A: ${tA.weight||'?'}kg x ${tA.reps} | B: ${tB.weight||'?'}kg x ${tB.reps}</span>`;
        } else if (ex.type === 'giant') subtext = "Giant Set";
        else if (ex.type === 'myo') {
            const t = getSmartTarget(ex, 0);
            subtext = "Myo Rep Match";
            if(t.weight) targetDisplay = `<span class="target-text">Set 1: ${t.weight}kg x ${t.reps}</span>`;
        }

        list.innerHTML += `
            <div class="card">
                <div class="row" style="align-items:flex-start">
                    <div style="flex:1">
                        <span class="meta-text" style="text-transform:uppercase; color:var(--accent); font-weight:bold; font-size:10px;">${ex.type}</span>
                        <span class="ex-title">${ex.name} ${ex.nameB ? `+ ${ex.nameB}` : ''}</span>
                        <span class="meta-text">${subtext}</span>
                        ${targetDisplay}
                    </div>
                    <div style="display:flex; flex-direction:column; gap:4px; margin-left:10px;">
                        <button class="btn-move" onclick="moveExercise(${idx}, -1)">‚ñ≤</button>
                        <button class="btn-move" onclick="moveExercise(${idx}, 1)">‚ñº</button>
                    </div>
                </div>
                <div class="grid-2" style="margin-top:10px;">
                    <button class="btn-secondary btn-small" onclick="openStats(${idx})">üìä Stats</button>
                    <button class="btn-primary btn-small" onclick="openLogModal(${idx})">üìù Log</button>
                </div>
                <button class="btn-secondary btn-small" style="width:100%; margin-top:8px; background:none; color:#666;" onclick="openEditModal(${idx})">Edit Config</button>
            </div>
        `;
    });
}

// --- LOGIC ENGINE ---
function getSmartTarget(ex, setIndex, side = null) {
    let min = parseInt(ex.min), max = parseInt(ex.max), inc = parseFloat(ex.inc);
    if (side === 'B') { min = parseInt(ex.minB); max = parseInt(ex.maxB); inc = parseFloat(ex.incB || ex.inc); }
    if(!ex.history || ex.history.length === 0) return { weight: '', reps: min, type: 'start' };
    
    const lastSession = ex.history[ex.history.length - 1];
    let prevSetThisRow = null;
    let setsArray = (ex.type==='superset') ? (side==='A'?lastSession.setsA:lastSession.setsB) : lastSession.sets;
    if(setsArray && setsArray[setIndex]) prevSetThisRow = setsArray[setIndex];
    if (!prevSetThisRow) return { weight: '', reps: min, type: 'new' };

    const baseWeight = parseFloat(prevSetThisRow.weight);
    
    // Myo Logic
    if(ex.type === 'myo') {
        let lastSetOfSession = setsArray[setsArray.length - 1];
        let triggered = false;
        if(lastSetOfSession) {
            const lsReps = parseInt(lastSetOfSession.reps);
            const lsRests = lastSetOfSession.rests ? parseInt(lastSetOfSession.rests) : 0;
            if (lsReps >= max && lsRests === 0) triggered = true;
        }
        if(setIndex === 0) {
            if(triggered) return { weight: baseWeight + inc, reps: min, type: 'progress', msg: 'Go Up' };
            else return { weight: baseWeight, reps: parseInt(prevSetThisRow.reps) + 1, type: 'hold', msg: '+1 Rep' };
        } else {
            return { weight: baseWeight, reps: "Match", type: 'hold' };
        }
    }

    // Normal Logic (Last Set Trigger)
    let lastSetOfSession = setsArray[setsArray.length - 1]; 
    if(!lastSetOfSession) return { weight: baseWeight, reps: min, type: 'hold' };
    const lastSetReps = parseInt(lastSetOfSession.reps);
    const lastSetRPE = lastSetOfSession.rpe ? parseFloat(lastSetOfSession.rpe) : 0;
    
    let maxRPEAllowed = 10;
    if(ex.targetRPE) { const parts = ex.targetRPE.match(/(\d+)/g); if(parts && parts.length > 0) maxRPEAllowed = parseFloat(parts[parts.length-1]); }

    let increaseGlobal = false;
    if (lastSetReps >= max) { if (lastSetRPE <= maxRPEAllowed) increaseGlobal = true; }

    if (increaseGlobal) return { weight: baseWeight + inc, reps: min, type: 'progress', msg: 'Go Up' };
    else {
        let targetReps = parseInt(prevSetThisRow.reps) + 1;
        if (targetReps > max) targetReps = max;
        return { weight: baseWeight, reps: targetReps, type: 'hold', msg: '+1 Rep' };
    }
}

// --- LOGGING ---
function openLogModal(idx) {
    editIndex = idx; const ex = exercises[idx];
    document.getElementById('modal-log').classList.remove('hidden'); document.getElementById('log-title').innerText = ex.name; document.getElementById('log-date').valueAsDate = new Date();
    
    // Notes Fix: Clear Input
    document.getElementById('log-notes').value = ''; 
    
    // Last Note Display
    const noteBox = document.getElementById('last-note-box');
    if(ex.history && ex.history.length > 0) {
        const lastNote = ex.history[ex.history.length-1].notes;
        if(lastNote) {
            noteBox.classList.remove('hidden');
            noteBox.innerText = "Last Session Note: " + lastNote;
        } else {
            noteBox.classList.add('hidden');
        }
    } else {
        noteBox.classList.add('hidden');
    }

    const container = document.getElementById('log-inputs'); container.innerHTML = '';
    if(ex.type === 'giant') addSetInputRow();
    else { const numSets = ex.sets || 3; for(let i=0; i<numSets; i++) addSetInputRow(i); }
}

function addSetInputRow(setIndex = null, isManual = false) {
    const ex = exercises[editIndex]; const div = document.createElement('div');
    const idx = setIndex !== null ? setIndex : document.querySelectorAll('.set-row, .super-block').length;

    if(ex.type === 'normal' || ex.type === 'myo') {
        const t = getSmartTarget(ex, idx);
        let badge = '';
        if(t.type === 'progress') badge = `<span class="target-pill">‚¨Ü Inc Wt</span>`;
        if(t.type === 'regress') badge = `<span class="target-pill regress">‚¨á Deload</span>`;
        
        let prevText = "";
        if(ex.history.length > 0) {
            const last = ex.history[ex.history.length-1];
            if(last.sets && last.sets[idx]) {
                const s = last.sets[idx];
                prevText = `Last: ${s.weight}kg x ${s.reps}`;
                if(ex.type === 'myo' && idx > 0) prevText += ` (${s.rests||0} rests)`;
                else if(s.rpe) prevText += ` @ ${s.rpe} RPE`;
            }
        }
        
        let thirdInput = `<input type="number" class="l-rpe" placeholder="RPE">`;
        if(ex.type === 'myo' && idx > 0) thirdInput = `<input type="number" class="l-rests" placeholder="Rests (Count)">`;

        let targetStr = `${t.weight||'?'}kg x ${t.reps||'?'}`;
        if(ex.type === 'myo' && idx > 0) targetStr = "Match Set 1 Reps";

        div.innerHTML = `<div style="background:#252525; padding:10px; border-radius:8px; margin-bottom:10px;"><div class="row"><span style="font-size:12px; font-weight:bold; color:#888;">SET ${idx+1}</span><span class="prev-data">${prevText}</span></div><div class="set-row" style="margin-top:5px; margin-bottom:0;"><input type="number" class="l-w" placeholder="Kg" value="${t.weight}"><input type="number" class="l-r" placeholder="Reps" value="${t.reps}">${thirdInput}${isManual ? '<button class="del-btn" onclick="this.closest(\'div\').parentElement.remove()">X</button>' : ''}</div><div class="row-start" style="margin-top:4px;">${badge}<span style="font-size:11px; color:var(--success);">Target: ${targetStr}</span></div></div>`;
    } 
    else if (ex.type === 'superset') {
        const tA = getSmartTarget(ex, idx, 'A'); const tB = getSmartTarget(ex, idx, 'B');
        const initA = (ex.name||'?').substring(0,2).toUpperCase(); const initB = (ex.nameB||'?').substring(0,2).toUpperCase();
        let prevA = "", prevB = "";
        if(ex.history.length > 0) {
            const last = ex.history[ex.history.length-1];
            if(last.setsA && last.setsA[idx]) prevA = `${last.setsA[idx].weight}x${last.setsA[idx].reps}`;
            if(last.setsB && last.setsB[idx]) prevB = `${last.setsB[idx].weight}x${last.setsB[idx].reps}`;
        }
        div.className = 'super-block';
        div.innerHTML = `<div style="font-size:12px; color:#666; margin-bottom:5px; text-align:right">SET ${idx+1}</div><div class="super-row"><div class="super-label">${initA}</div><input type="number" class="l-w-a" placeholder="Kg" value="${tA.weight}"><input type="number" class="l-r-a" placeholder="Reps" value="${tA.reps}"><input type="number" class="l-rpe-a" placeholder="RPE"></div><div style="font-size:10px; color:#aaa; text-align:right; margin-top:-4px; margin-bottom:4px;">Last: ${prevA} | Target: ${tA.weight}kg</div><div class="super-row"><div class="super-label">${initB}</div><input type="number" class="l-w-b" placeholder="Kg" value="${tB.weight}"><input type="number" class="l-r-b" placeholder="Reps" value="${tB.reps}"><input type="number" class="l-rpe-b" placeholder="RPE"></div><div style="font-size:10px; color:#aaa; text-align:right; margin-top:-4px;">Last: ${prevB} | Target: ${tB.weight}kg</div>${isManual ? '<div class="super-del" onclick="this.parentElement.remove()">X</div>' : ''}`;
    } 
    else if (ex.type === 'giant') div.innerHTML = `<label>Giant Set Totals</label><div class="grid-2"><input type="number" id="log-g-wt" placeholder="Weight"><input type="number" id="log-g-reps" placeholder="Total Reps"></div>`;
    document.getElementById('log-inputs').appendChild(div);
}

function saveLog() {
    const ex = exercises[editIndex]; const entry = { date: document.getElementById('log-date').value, notes: document.getElementById('log-notes').value };
    if(ex.type === 'giant') { entry.weight = document.getElementById('log-g-wt').value; entry.totalReps = document.getElementById('log-g-reps').value; }
    else if (ex.type === 'superset') {
        const blocks = document.querySelectorAll('.super-block'), sA = [], sB = [];
        blocks.forEach(b => { sA.push({ weight: b.querySelector('.l-w-a').value, reps: b.querySelector('.l-r-a').value, rpe: b.querySelector('.l-rpe-a').value }); sB.push({ weight: b.querySelector('.l-w-b').value, reps: b.querySelector('.l-r-b').value, rpe: b.querySelector('.l-rpe-b').value }); });
        entry.setsA = sA; entry.setsB = sB;
    } else {
        const rows = document.querySelectorAll('.l-w'), sets = [];
        rows.forEach(r => { 
            if(r.value) { 
                const parent = r.parentElement;
                let s = { weight: r.value, reps: parent.querySelector('.l-r').value };
                if(parent.querySelector('.l-rpe')) s.rpe = parent.querySelector('.l-rpe').value;
                if(parent.querySelector('.l-rests')) s.rests = parent.querySelector('.l-rests').value;
                sets.push(s); 
            } 
        });
        entry.sets = sets;
    }
    ex.history.push(entry); localStorage.setItem('exercises_v6', JSON.stringify(exercises)); closeModals(); renderExercises();
}

// --- ANALYTICS ---
function openStats(idx) {
    const ex = exercises[idx]; toggleViews('stats'); document.getElementById('stats-title').innerText = ex.name;
    const table = document.getElementById('stats-table'); table.innerHTML = `<thead><tr><th>Date</th><th>Sets</th><th>Best</th></tr></thead><tbody></tbody>`;
    const tbody = table.querySelector('tbody'), dates = [], maxWeights = [], maxReps = [];
    ex.history.slice(-4).reverse().forEach(h => {
        const d = new Date(h.date).toLocaleDateString('en-US', {month:'short', day:'numeric'}); dates.push(d);
        let bestW=0, bestR=0, setStr="", bestStr="-";
        if((ex.type==='normal' || ex.type==='myo') && h.sets) { 
            h.sets.forEach(s=>{ 
                setStr+=`${s.weight}x${s.reps}`;
                if(s.rests) setStr+=`(${s.rests}r)`;
                setStr+=`<br>`;
                if(parseFloat(s.weight)>bestW){bestW=s.weight; bestR=s.reps;} 
            }); 
            bestStr=`${bestW}kg x ${bestR}`; 
        }
        else if(ex.type==='superset' && h.setsA) { 
            setStr = "Superset"; let bestWA=0, bestWB=0;
            h.setsA.forEach(s=>{ if(parseFloat(s.weight)>bestWA) bestWA=s.weight; }); 
            if(h.setsB) h.setsB.forEach(s=>{ if(parseFloat(s.weight)>bestWB) bestWB=s.weight; });
            bestStr=`${bestWA}kg(A)/${bestWB}kg(B)`; bestW=bestWA; 
        }
        else if(ex.type==='giant') { bestW=h.weight; bestR=h.totalReps; bestStr=`${bestW}kg x ${bestR}`; }
        maxWeights.push(bestW); maxReps.push(bestR||0); tbody.innerHTML+=`<tr><td>${d}</td><td>${setStr}</td><td>${bestStr}</td></tr>`;
    });
    if(chartInstance) chartInstance.destroy();
    const ctx = document.getElementById('progressChart').getContext('2d');
    chartInstance = new Chart(ctx, { type: 'line', data: { labels: dates.reverse(), datasets: [{label:'Strength', data:maxWeights.reverse(), borderColor:'#0a84ff', yAxisID:'y'}, {label:'Vol', data:maxReps.reverse(), borderColor:'#30d158', yAxisID:'y1'}] }, options: { maintainAspectRatio:false, scales:{y:{display:true,position:'left',grid:{color:'#333'}}, y1:{display:true,position:'right',grid:{drawOnChartArea:false}}} } });
}

// --- UTILS ---
function closeModals() { document.querySelectorAll('.modal').forEach(m => m.classList.add('hidden')); }
function renderConfigFields() {
    const type = document.getElementById('cfg-type').value, div = document.getElementById('cfg-dynamic-area'); div.innerHTML = '';
    const rpeHTML = `<input id="cfg-rpe" placeholder="Target RPE (e.g. 7-9)">`;
    if(type === 'normal' || type === 'myo') div.innerHTML = `<input id="cfg-name" placeholder="Name"><div class="grid-2"><input id="cfg-sets" placeholder="Sets"><input id="cfg-inc" placeholder="Increment"></div><div class="grid-2"><input id="cfg-min" placeholder="Min Reps"><input id="cfg-max" placeholder="Max Reps"></div>${rpeHTML}`;
    else if (type === 'superset') div.innerHTML = `<div class="grid-2"><input id="cfg-sets" placeholder="Sets (3)"><input id="cfg-inc" placeholder="Common Inc (e.g. 2.5)"></div>${rpeHTML}<hr style="border:1px solid #333; margin:10px 0;"><label class="meta-text" style="color:var(--accent)">Exercise A</label><input id="cfg-name" placeholder="Name"><div class="grid-2"><input id="cfg-min" placeholder="Min"><input id="cfg-max" placeholder="Max"></div><hr style="border:1px solid #333; margin:10px 0;"><label class="meta-text" style="color:#ff9f0a">Exercise B</label><input id="cfg-name-b" placeholder="Name"><div class="grid-3"><input id="cfg-min-b" placeholder="Min"><input id="cfg-max-b" placeholder="Max"><input id="cfg-inc-b" placeholder="Inc B (opt)"></div>`;
    else if (type === 'giant') div.innerHTML = `<input id="cfg-name" placeholder="Name"><div class="grid-2"><input id="cfg-min" placeholder="Start"><input id="cfg-max" placeholder="End"></div><div class="grid-2"><input id="cfg-inc" placeholder="Wt Inc"><input id="cfg-rep-inc" placeholder="Rep Inc"></div>`;
}
function openEditModal(idx = null) {
    document.getElementById('modal-edit').classList.remove('hidden'); editIndex = idx;
    document.getElementById('cfg-dynamic-area').innerHTML = ''; document.getElementById('cfg-type').value = 'normal';
    if(idx === null) renderConfigFields();
    else {
        const ex = exercises[idx]; document.getElementById('cfg-day').value = ex.day; document.getElementById('cfg-type').value = ex.type; document.getElementById('btn-delete').classList.remove('hidden'); renderConfigFields();
        setTimeout(() => {
            document.getElementById('cfg-name').value = ex.name;
            if(ex.type==='normal' || ex.type==='myo'){ document.getElementById('cfg-sets').value=ex.sets; document.getElementById('cfg-inc').value=ex.inc; document.getElementById('cfg-min').value=ex.min; document.getElementById('cfg-max').value=ex.max; document.getElementById('cfg-rpe').value=ex.targetRPE||''; }
            else if(ex.type==='superset'){ document.getElementById('cfg-sets').value=ex.sets; document.getElementById('cfg-inc').value=ex.inc; document.getElementById('cfg-min').value=ex.min; document.getElementById('cfg-max').value=ex.max; document.getElementById('cfg-name-b').value=ex.nameB; document.getElementById('cfg-min-b').value=ex.minB; document.getElementById('cfg-max-b').value=ex.maxB; document.getElementById('cfg-inc-b').value=ex.incB||ex.inc; document.getElementById('cfg-rpe').value=ex.targetRPE||''; }
            else if(ex.type==='giant'){ document.getElementById('cfg-min').value=ex.min; document.getElementById('cfg-max').value=ex.max; document.getElementById('cfg-inc').value=ex.inc; document.getElementById('cfg-rep-inc').value=ex.repInc||10; }
        }, 50);
    }
}
function saveExercise() {
    const ex = editIndex !== null ? exercises[editIndex] : { id: Date.now(), history: [] };
    ex.day = document.getElementById('cfg-day').value; ex.name = document.getElementById('cfg-name').value; ex.type = document.getElementById('cfg-type').value;
    if(ex.type==='normal' || ex.type==='myo'){ ex.sets=document.getElementById('cfg-sets').value; ex.inc=document.getElementById('cfg-inc').value; ex.min=document.getElementById('cfg-min').value; ex.max=document.getElementById('cfg-max').value; ex.targetRPE=document.getElementById('cfg-rpe').value; }
    if(ex.type==='superset'){ ex.sets=document.getElementById('cfg-sets').value; ex.inc=document.getElementById('cfg-inc').value; ex.min=document.getElementById('cfg-min').value; ex.max=document.getElementById('cfg-max').value; ex.targetRPE=document.getElementById('cfg-rpe').value; ex.nameB=document.getElementById('cfg-name-b').value; ex.minB=document.getElementById('cfg-min-b').value; ex.maxB=document.getElementById('cfg-max-b').value; ex.incB=document.getElementById('cfg-inc-b').value; }
    if(ex.type==='giant'){ ex.min=document.getElementById('cfg-min').value; ex.max=document.getElementById('cfg-max').value; ex.inc=document.getElementById('cfg-inc').value; ex.repInc=document.getElementById('cfg-rep-inc').value; }
    if(editIndex === null) exercises.push(ex); localStorage.setItem('exercises_v6', JSON.stringify(exercises)); closeModals(); if(activeDay) renderExercises(); else renderHome();
}
function moveDay(d,dir) { const i=dayOrder.indexOf(d); if(i+dir>=0 && i+dir<dayOrder.length){ [dayOrder[i],dayOrder[i+dir]]=[dayOrder[i+dir],dayOrder[i]]; renderHome(); } }
function moveExercise(i,dir) { const ex=exercises[i], sub=exercises.map((e,idx)=>e.day===ex.day?idx:-1).filter(n=>n!==-1), pos=sub.indexOf(i); if(pos+dir>=0 && pos+dir<sub.length){ const swap=sub[pos+dir]; [exercises[i],exercises[swap]]=[exercises[swap],exercises[i]]; localStorage.setItem('exercises_v6', JSON.stringify(exercises)); renderExercises(); } }
function deleteExercise(){ if(confirm("Delete?")){ exercises.splice(editIndex,1); localStorage.setItem('exercises_v6', JSON.stringify(exercises)); closeModals(); renderExercises(); } }
function resetAllData(){ toggleMenu(); if(confirm("Reset All?")){ localStorage.clear(); location.reload(); } }

renderHome();
</script>
</body>
</html>
