<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Tracker V3</title>
    <link rel="apple-touch-icon" href="https://img.icons8.com/ios-filled/180/007aff/dumbbell.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/ios-filled/180/007aff/dumbbell.png">

    <style>
        :root { --bg: #121212; --card: #1c1c1e; --text: #f2f2f7; --accent: #0a84ff; --success: #30d158; --danger: #ff453a; --sub: #8e8e93; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; }
        
        /* Layout */
        .container { padding: 16px; max-width: 600px; margin: 0 auto; }
        h1 { font-size: 28px; font-weight: 800; margin: 0 0 20px 0; letter-spacing: -0.5px; }
        h2 { margin: 0 0 10px 0; font-size: 20px; }
        
        /* Components */
        .card { background: var(--card); border-radius: 14px; padding: 16px; margin-bottom: 12px; position: relative; border: 1px solid #2c2c2e; }
        .tag { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; margin-bottom: 6px; }
        .tag-normal { background: rgba(10, 132, 255, 0.15); color: var(--accent); }
        .tag-super { background: rgba(255, 159, 10, 0.15); color: #ff9f0a; }
        .tag-giant { background: rgba(191, 90, 242, 0.15); color: #bf5af2; }
        
        .row { display: flex; justify-content: space-between; align-items: center; }
        .btn-text { background: none; border: none; color: var(--accent); font-size: 14px; font-weight: 600; padding: 5px; }
        
        /* Typography */
        .ex-title { font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 4px; display: block;}
        .target-text { color: var(--success); font-weight: 600; font-size: 15px; display: block; margin-top: 4px; }
        .meta-text { font-size: 13px; color: var(--sub); margin-top: 4px; display: block; }
        .technique-badge { display: block; font-size: 12px; color: #ff9f0a; margin-top: 6px; font-style: italic; }

        /* Forms */
        input, select, textarea { background: #2c2c2e; border: none; color: white; padding: 12px; border-radius: 10px; width: 100%; box-sizing: border-box; font-size: 16px; margin-bottom: 12px; font-family: inherit; }
        input:focus { outline: 2px solid var(--accent); }
        
        button { border: none; padding: 14px; border-radius: 12px; font-size: 16px; font-weight: 600; width: 100%; cursor: pointer; margin-top: 8px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-secondary { background: #3a3a3c; color: white; }
        .btn-success { background: var(--success); color: black; }
        .btn-danger { background: var(--danger); color: white; }

        /* Floating Button */
        .fab { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; border-radius: 30px; background: var(--accent); color: white; font-size: 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px rgba(10,132,255,0.4); border: none; z-index: 50; }

        /* Modals */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 100; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .hidden { display: none !important; }

        /* Grid inputs */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .grid-superset { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 6px; } /* W1 R1 W2 R2 */

        .set-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
        .del-btn { width: 30px; height: 44px; padding: 0; margin: 0; display: flex; align-items: center; justify-content: center; background: #3a3a3c; color: var(--danger); }

    </style>
</head>
<body>

<div class="container" id="app">
    <div id="view-home">
        <div class="row"><h1>My Program</h1></div>
        <div id="days-list"></div>
        <div style="margin-top:50px; text-align:center;">
             <button class="btn-text" style="color: #444; font-size:12px;" onclick="resetAllData()">Reset All Data</button>
        </div>
    </div>

    <div id="view-day" class="hidden">
        <div class="row" style="margin-bottom: 20px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <button class="btn-text" style="font-size:24px; padding:0;" onclick="goHome()">&#8592;</button>
                <h1 id="day-title" style="margin:0;">Day</h1>
            </div>
        </div>
        <div id="exercises-list"></div>
    </div>
</div>

<div id="modal-edit" class="modal hidden">
    <h2>Setup Exercise</h2>
    
    <label class="meta-text">Day (Folder)</label>
    <input type="text" id="cfg-day" placeholder="e.g. Push A" list="day-list-suggestions">
    <datalist id="day-list-suggestions"></datalist>

    <label class="meta-text">Type</label>
    <select id="cfg-type" onchange="renderConfigFields()">
        <option value="normal">Normal (Sets x Reps)</option>
        <option value="superset">Superset (2 Exercises)</option>
        <option value="giant">Giant Set (Rep Accumulation)</option>
    </select>

    <div id="cfg-dynamic-area" style="margin-top:15px;"></div>

    <button class="btn-success" onclick="saveExercise()">Save</button>
    <button class="btn-secondary" onclick="closeModals()">Cancel</button>
    <button class="btn-danger" id="btn-delete" style="margin-top:20px;" onclick="deleteExercise()">Delete</button>
</div>

<div id="modal-log" class="modal hidden">
    <h2 id="log-title">Log Workout</h2>
    
    <div id="log-history" style="background:#2c2c2e; padding:12px; border-radius:10px; margin-bottom:15px; font-size:14px; border-left:3px solid var(--accent); color:#ddd; white-space: pre-line;"></div>

    <div id="log-target-box" style="margin-bottom:20px;"></div>

    <div id="log-inputs"></div>

    <button class="btn-secondary" onclick="addSetInputRow()" id="btn-add-set">+ Add Set</button>

    <label class="meta-text" style="margin-top:20px;">Session Notes</label>
    <textarea id="log-notes" rows="2"></textarea>

    <button class="btn-success" onclick="saveLog()">Complete</button>
    <button class="btn-secondary" onclick="closeModals()">Cancel</button>
</div>

<button class="fab" onclick="openEditModal()">+</button>

<script>
// --- Data State ---
let exercises = JSON.parse(localStorage.getItem('exercises_v3')) || [];
let activeDay = null;
let editIndex = null;

// --- Config Renderers ---
function renderConfigFields() {
    const type = document.getElementById('cfg-type').value;
    const div = document.getElementById('cfg-dynamic-area');
    div.innerHTML = '';

    if (type === 'normal') {
        div.innerHTML = `
            <input type="text" id="cfg-name" placeholder="Exercise Name">
            <div class="grid-2">
                <input type="number" id="cfg-sets" placeholder="Target Sets (e.g. 3)">
                <input type="number" id="cfg-inc" placeholder="Wt Increment (2.5)">
            </div>
            <div class="grid-2">
                <input type="number" id="cfg-min" placeholder="Min Reps (8)">
                <input type="number" id="cfg-max" placeholder="Max Reps (10)">
            </div>
            <input type="text" id="cfg-tech" placeholder="Last Set Intensity (e.g. Drop Set)">
        `;
    } else if (type === 'superset') {
        div.innerHTML = `
            <div class="grid-2">
                <input type="number" id="cfg-sets" placeholder="Target Sets (3)">
                <input type="text" id="cfg-tech" placeholder="Intensity Tech (Shared)">
            </div>
            <hr style="border:1px solid #333; margin:10px 0;">
            <label class="meta-text" style="color:var(--accent)">Exercise A</label>
            <input type="text" id="cfg-name" placeholder="Name (e.g. Bench)">
            <div class="grid-3">
                <input type="number" id="cfg-min" placeholder="Min">
                <input type="number" id="cfg-max" placeholder="Max">
                <input type="number" id="cfg-inc" placeholder="Inc">
            </div>
            <hr style="border:1px solid #333; margin:10px 0;">
            <label class="meta-text" style="color:#ff9f0a">Exercise B</label>
            <input type="text" id="cfg-name-b" placeholder="Name (e.g. Flys)">
            <div class="grid-3">
                <input type="number" id="cfg-min-b" placeholder="Min">
                <input type="number" id="cfg-max-b" placeholder="Max">
                <input type="number" id="cfg-inc-b" placeholder="Inc">
            </div>
        `;
    } else if (type === 'giant') {
        div.innerHTML = `
            <input type="text" id="cfg-name" placeholder="Exercise Name">
            <div class="grid-2">
                <div><label class="meta-text">Start Reps</label><input type="number" id="cfg-min" value="30"></div>
                <div><label class="meta-text">Target Reps</label><input type="number" id="cfg-max" value="70"></div>
            </div>
            <div class="grid-2">
                <div><label class="meta-text">Add Reps/Wk</label><input type="number" id="cfg-rep-inc" value="10"></div>
                <div><label class="meta-text">Wt Increment</label><input type="number" id="cfg-inc" value="5"></div>
            </div>
            <p class="meta-text" style="color:var(--sub)">Goal: Hit Target Reps total. Then Weight goes up, Reps reset to Start.</p>
        `;
    }
}

// --- Views & Navigation ---
function goHome() {
    activeDay = null;
    document.getElementById('view-home').classList.remove('hidden');
    document.getElementById('view-day').classList.add('hidden');
    renderHome();
}

function renderHome() {
    const list = document.getElementById('days-list');
    list.innerHTML = '';
    const days = [...new Set(exercises.map(e => e.day))].sort();
    
    // Fill datalist
    const dl = document.getElementById('day-list-suggestions');
    dl.innerHTML = days.map(d => `<option value="${d}">`).join('');

    days.forEach(day => {
        const count = exercises.filter(e => e.day === day).length;
        list.innerHTML += `
            <div class="card" onclick="openDay('${day}')">
                <div class="row">
                    <span class="ex-title">${day}</span>
                    <span style="color:#666;">${count} ></span>
                </div>
            </div>`;
    });
}

function openDay(day) {
    activeDay = day;
    document.getElementById('view-home').classList.add('hidden');
    document.getElementById('view-day').classList.remove('hidden');
    document.getElementById('day-title').innerText = day;
    renderExercises();
}

function renderExercises() {
    const list = document.getElementById('exercises-list');
    list.innerHTML = '';
    
    exercises.forEach((ex, idx) => {
        if(ex.day !== activeDay) return;

        let tag = `<span class="tag tag-normal">Normal</span>`;
        let targetHTML = '';

        if(ex.type === 'superset') tag = `<span class="tag tag-super">Superset</span>`;
        if(ex.type === 'giant') tag = `<span class="tag tag-giant">Giant Set</span>`;

        const target = calcTarget(ex); // Returns string or object
        
        if (ex.type === 'superset') {
            targetHTML = `
                <div class="target-text"><span style="color:var(--accent)">A:</span> ${target.A}</div>
                <div class="target-text"><span style="color:#ff9f0a">B:</span> ${target.B}</div>
            `;
        } else {
            targetHTML = `<div class="target-text">${target}</div>`;
        }

        let tech = ex.tech ? `<span class="technique-badge">Reminder: ${ex.tech}</span>` : '';

        list.innerHTML += `
            <div class="card">
                <div class="row">
                    <div>
                        ${tag}
                        <span class="ex-title">${ex.name} ${ex.nameB ? `+ ${ex.nameB}` : ''}</span>
                    </div>
                    <button class="btn-text" onclick="openEditModal(${idx})">Edit</button>
                </div>
                ${targetHTML}
                ${tech}
                <button class="btn-primary" onclick="openLogModal(${idx})">Log</button>
            </div>
        `;
    });
}

// --- Logic Core ---
function calcTarget(ex) {
    if(!ex.history || ex.history.length === 0) {
        if(ex.type === 'giant') return `Goal: ${ex.min} Total Reps`;
        if(ex.type === 'superset') return { A: `${ex.min}-${ex.max} reps`, B: `${ex.minB}-${ex.maxB} reps` };
        return `${ex.min}-${ex.max} reps`;
    }

    const last = ex.history[ex.history.length - 1];

    if(ex.type === 'giant') {
        const lastTotal = last.totalReps || 0;
        const lastWt = last.weight || 0;
        // Giant Logic: If hit max target, reset reps, inc weight. Else add 10 reps.
        if (lastTotal >= ex.max) {
            return `${parseFloat(lastWt) + parseFloat(ex.inc)}kg for ${ex.min} Total Reps`;
        } else {
            return `${lastWt}kg for ${parseInt(lastTotal) + parseInt(ex.repInc)} Total Reps`;
        }
    }

    if(ex.type === 'normal') {
        const best = getBestSet(last.sets);
        if(best.reps >= ex.max) {
            return `${parseFloat(best.weight) + parseFloat(ex.inc)}kg x ${ex.min}-${ex.max}`;
        } else {
            return `${best.weight}kg x ${parseInt(best.reps) + 1}`;
        }
    }

    if(ex.type === 'superset') {
        // Independent Double Progression
        const bestA = getBestSet(last.setsA);
        const bestB = getBestSet(last.setsB);
        
        let tA = (bestA.reps >= ex.max) 
            ? `${parseFloat(bestA.weight) + parseFloat(ex.inc)}kg x ${ex.min}` 
            : `${bestA.weight}kg x ${parseInt(bestA.reps) + 1}`;
            
        let tB = (bestB.reps >= ex.maxB) 
            ? `${parseFloat(bestB.weight) + parseFloat(ex.incB)}kg x ${ex.minB}` 
            : `${bestB.weight}kg x ${parseInt(bestB.reps) + 1}`;

        return { A: tA, B: tB };
    }
}

function getBestSet(sets) {
    if(!sets) return { weight:0, reps:0 };
    return sets.reduce((p, c) => {
        if(parseFloat(c.weight) > parseFloat(p.weight)) return c;
        if(parseFloat(c.weight) == parseFloat(p.weight) && parseInt(c.reps) > parseInt(p.reps)) return c;
        return p;
    }, {weight:0, reps:0});
}

// --- CRUD Operations ---
function saveExercise() {
    const day = document.getElementById('cfg-day').value;
    const type = document.getElementById('cfg-type').value;
    const name = document.getElementById('cfg-name').value;
    if(!day || !name) return alert("Name and Day are required");

    let newEx = {
        day, type, name,
        history: (editIndex !== null) ? exercises[editIndex].history : []
    };

    if(type === 'normal') {
        newEx.sets = document.getElementById('cfg-sets').value || 3;
        newEx.min = document.getElementById('cfg-min').value;
        newEx.max = document.getElementById('cfg-max').value;
        newEx.inc = document.getElementById('cfg-inc').value;
        newEx.tech = document.getElementById('cfg-tech').value;
    } 
    else if (type === 'superset') {
        newEx.sets = document.getElementById('cfg-sets').value || 3;
        newEx.tech = document.getElementById('cfg-tech').value;
        newEx.min = document.getElementById('cfg-min').value;
        newEx.max = document.getElementById('cfg-max').value;
        newEx.inc = document.getElementById('cfg-inc').value;
        
        newEx.nameB = document.getElementById('cfg-name-b').value;
        newEx.minB = document.getElementById('cfg-min-b').value;
        newEx.maxB = document.getElementById('cfg-max-b').value;
        newEx.incB = document.getElementById('cfg-inc-b').value;
    } 
    else if (type === 'giant') {
        newEx.min = document.getElementById('cfg-min').value; // Start Reps
        newEx.max = document.getElementById('cfg-max').value; // Target Reps
        newEx.repInc = document.getElementById('cfg-rep-inc').value; 
        newEx.inc = document.getElementById('cfg-inc').value; // Wt Inc
    }

    if(editIndex !== null) exercises[editIndex] = newEx;
    else exercises.push(newEx);

    localStorage.setItem('exercises_v3', JSON.stringify(exercises));
    closeModals();
    if(activeDay) renderExercises(); else renderHome();
}

function deleteExercise() {
    if(confirm("Delete this exercise?")) {
        exercises.splice(editIndex, 1);
        localStorage.setItem('exercises_v3', JSON.stringify(exercises));
        closeModals();
        if(activeDay) renderExercises(); else renderHome();
    }
}

// --- Logging System ---
function openLogModal(idx) {
    editIndex = idx;
    const ex = exercises[idx];
    document.getElementById('modal-log').classList.remove('hidden');
    document.getElementById('log-title').innerText = ex.name;
    const container = document.getElementById('log-inputs');
    container.innerHTML = '';

    // Render Previous Data
    const histDiv = document.getElementById('log-history');
    if(ex.history && ex.history.length > 0) {
        const last = ex.history[ex.history.length - 1];
        histDiv.innerText = `Last Note: ${last.notes || '-'}`;
    } else {
        histDiv.innerText = "No previous history.";
    }

    // Render Targets
    const targetDiv = document.getElementById('log-target-box');
    const t = calcTarget(ex);
    if(ex.type === 'superset') {
        targetDiv.innerHTML = `<div style="color:var(--accent)">A: ${t.A}</div><div style="color:#ff9f0a">B: ${t.B}</div>`;
    } else {
        targetDiv.innerHTML = `<div style="color:var(--success); font-size:18px; font-weight:bold;">${t}</div>`;
    }

    // Render Inputs based on Type
    document.getElementById('btn-add-set').classList.remove('hidden'); // Show by default

    if(ex.type === 'giant') {
        document.getElementById('btn-add-set').classList.add('hidden'); // Hide for Giant
        container.innerHTML = `
            <div class="grid-2">
                <div><label class="meta-text">Weight Used</label><input type="number" id="log-g-wt"></div>
                <div><label class="meta-text">Total Reps</label><input type="number" id="log-g-reps"></div>
            </div>
            <p class="meta-text">Rest-pause until you can't continue.</p>
        `;
    } else {
        // Normal & Superset use rows
        // Pre-fill number of sets from Config
        const count = ex.sets || 3;
        for(let i=0; i<count; i++) addSetInputRow(ex.type);
    }
    
    document.getElementById('log-notes').value = '';
}

function addSetInputRow(forcedType) {
    const ex = exercises[editIndex];
    const type = forcedType || ex.type;
    const div = document.createElement('div');
    
    if(type === 'superset') {
        div.className = 'set-row';
        div.innerHTML = `
            <div class="grid-superset" style="flex:1">
                <input type="number" class="l-w-a" placeholder="A Kg">
                <input type="number" class="l-r-a" placeholder="A Rep">
                <input type="number" class="l-w-b" placeholder="B Kg">
                <input type="number" class="l-r-b" placeholder="B Rep">
            </div>
            <button class="del-btn" onclick="this.parentElement.remove()">X</button>
        `;
    } else {
        // Normal
        div.className = 'set-row';
        div.innerHTML = `
            <input type="number" class="l-w" placeholder="Kg">
            <input type="number" class="l-r" placeholder="Reps">
            <input type="number" class="l-rpe" placeholder="RPE">
            <button class="del-btn" onclick="this.parentElement.remove()">X</button>
        `;
    }
    document.getElementById('log-inputs').appendChild(div);
}

function saveLog() {
    const ex = exercises[editIndex];
    const note = document.getElementById('log-notes').value;
    const entry = { date: new Date().toISOString(), notes: note };

    if(ex.type === 'giant') {
        const w = document.getElementById('log-g-wt').value;
        const r = document.getElementById('log-g-reps').value;
        if(!w || !r) return alert("Fill data");
        entry.weight = w;
        entry.totalReps = r;
    } else if (ex.type === 'superset') {
        const rows = document.querySelectorAll('.set-row');
        const sA = [], sB = [];
        rows.forEach(r => {
            const wa = r.querySelector('.l-w-a').value;
            const ra = r.querySelector('.l-r-a').value;
            const wb = r.querySelector('.l-w-b').value;
            const rb = r.querySelector('.l-r-b').value;
            if(wa) sA.push({weight: wa, reps: ra});
            if(wb) sB.push({weight: wb, reps: rb});
        });
        if(sA.length === 0) return alert("Log data");
        entry.setsA = sA;
        entry.setsB = sB;
    } else {
        const rows = document.querySelectorAll('.set-row');
        const sets = [];
        rows.forEach(r => {
            const w = r.querySelector('.l-w').value;
            const rp = r.querySelector('.l-r').value;
            const rpe = r.querySelector('.l-rpe').value;
            if(w) sets.push({weight: w, reps: rp, rpe: rpe});
        });
        if(sets.length === 0) return alert("Log data");
        entry.sets = sets;
    }

    ex.history.push(entry);
    localStorage.setItem('exercises_v3', JSON.stringify(exercises));
    closeModals();
    renderExercises();
}

// --- Utils ---
function closeModals() {
    document.querySelectorAll('.modal').forEach(m => m.classList.add('hidden'));
}
function openEditModal(idx = null) {
    document.getElementById('modal-edit').classList.remove('hidden');
    editIndex = idx;
    
    // Reset fields
    document.getElementById('cfg-dynamic-area').innerHTML = '';
    document.getElementById('cfg-type').value = 'normal';
    
    if(idx !== null) {
        // Load Data
        const ex = exercises[idx];
        document.getElementById('cfg-day').value = ex.day;
        document.getElementById('cfg-type').value = ex.type;
        document.getElementById('btn-delete').classList.remove('hidden');
        renderConfigFields();
        
        // Fill dynamic
        setTimeout(() => {
            document.getElementById('cfg-name').value = ex.name;
            document.getElementById('cfg-inc').value = ex.inc;
            document.getElementById('cfg-min').value = ex.min;
            document.getElementById('cfg-max').value = ex.max;
            
            if(ex.type === 'normal') {
                document.getElementById('cfg-sets').value = ex.sets;
                document.getElementById('cfg-tech').value = ex.tech || '';
            }
            if(ex.type === 'superset') {
                document.getElementById('cfg-sets').value = ex.sets;
                document.getElementById('cfg-tech').value = ex.tech || '';
                document.getElementById('cfg-name-b').value = ex.nameB;
                document.getElementById('cfg-min-b').value = ex.minB;
                document.getElementById('cfg-max-b').value = ex.maxB;
                document.getElementById('cfg-inc-b').value = ex.incB;
            }
            if(ex.type === 'giant') {
                document.getElementById('cfg-rep-inc').value = ex.repInc;
            }
        }, 50);
    } else {
        document.getElementById('cfg-day').value = activeDay || '';
        document.getElementById('btn-delete').classList.add('hidden');
        renderConfigFields();
    }
}
function resetAllData() {
    if(confirm("Delete ALL history and exercises? Cannot be undone.")) {
        localStorage.removeItem('exercises_v3');
        location.reload();
    }
}

// Init
renderHome();
</script>
</body>
</html>
